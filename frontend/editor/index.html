<!DOCTYPE html>
<html>
<!-- Include stylesheet -->
<title>Polylets editor</title>

<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="./jszip-master/dist/jszip.js"></script>
<script type="text/javascript" src="FileSaver.js-master/dist/FileSaver.js"></script>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="styles.css">

<body>


    <h1>Editor</h1>

    <div class="editor">

        <div id="annotations" class="annotation">


            <p style="border: 1px solid #d8d8d8;">
                <script>
                    getData();
                    async function getData() {
                        console.log('da');
                        const res = await fetch('/notes');
                        const data = await res.json();

                        for (item of data) {
                            const newAnnot = document.createElement('div');
                            const passage = document.createElement('a');
                            const note = document.createElement('p');
                            const strPassage = document.createTextNode(`${item.passage}`);
                            const strNote = document.createTextNode(`${item.annotation}`);

                            newAnnot.setAttribute("id", `${item._id}`);
                            newAnnot.setAttribute("draggable", "true");
                            newAnnot.setAttribute("ondragstart", `drag(event)`);

                            newAnnot.setAttribute("data-fileid", `${item.fileId}`);
                            newAnnot.setAttribute("data-startOffset", `${item.startOffset}`)
                            newAnnot.setAttribute("data-endOffset", `${item.endOffset}`)
                            newAnnot.setAttribute("data-startIndex", `${item.startIndex}`)
                            newAnnot.setAttribute("data-endIndex", `${item.endIndex}`)

                            note.setAttribute("class", "annot-note");
                            passage.setAttribute("class", "annot-pass");
                            newAnnot.setAttribute("class", "element");

                            passage.appendChild(strPassage);
                            note.appendChild(strNote);
                            newAnnot.appendChild(passage);
                            newAnnot.appendChild(note);

                            // const butt = document.createElement('button');
                            // butt.setAttribute("onclick", `insertCitation("${item._id}")`)
                            // butt.textContent = "insert";
                            document.getElementById("annotations").append(newAnnot);
                        }
                    }
                </script>
            </p>
        </div>



        <button id="save-button">Save</button>
            


        <!-- Create the editor container -->
        <div class="document">
            <div id="editor" ondrop="drop(event)">
                <p>Hello World!</p>
                <p>Some initial <strong>bold</strong> text</p>
                <p><br></p>
            </div>
        </div>



        <!-- Include the Quill library -->
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

        <!-- Initialize Quill editor -->
        <script>

            let Inline = Quill.import('blots/inline');

            class HighlightBlot extends Inline {
                static create(id) {
                    let node = super.create();
                    // Sanitize url if desired
                    console.log("id is");
                    console.log(id);

                    //node.setAttribute('id', "on");
                    //highlight thingy=
                    node.setAttribute("id", "elementId" + iter);
                    node.setAttribute('onmouseover', "highlight("+id+")");
                    node.setAttribute('onmouseout', "unhighlight("+id+")");
                    //handful for reader
                    node.setAttribute("data-fileId", document.getElementById(id).attributes[3].value );
                    node.setAttribute("data-startOffset", document.getElementById(id).attributes[4].value );
                    node.setAttribute("data-endOffset", document.getElementById(id).attributes[5].value );
                    node.setAttribute("data-startIndex", document.getElementById(id).attributes[6].value );
                    node.setAttribute("data-endIndex", document.getElementById(id).attributes[7].value );
                    return node;
                }
            }

            HighlightBlot.blotName = 'highlight';
            HighlightBlot.tagName = 'a';

            var iter = 0;

            Quill.register(HighlightBlot);


            var toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],
                ['link', 'image', 'video', 'formula'],
            ];

            const quill = new Quill('#editor', {
                modules: {
                    toolbar : toolbarOptions
                },
                
                theme: 'snow'
            });


            function downloadInnerHtml(filename, elId, mimeType) {
                var elHtml = document.getElementById(elId).firstElementChild.innerHTML;
                var link = document.createElement('a');
                mimeType = mimeType || 'text/plain';

                link.setAttribute('download', filename);
                link.setAttribute('href', 'data:' + mimeType + ';charset=utf-8,' + encodeURIComponent(elHtml));
                link.click(); 
            }

            var fileName =  'file.html'; // You can use the .txt extension if you want

            $('#save-button').click(function(){
                console.log("save");
                downloadInnerHtml(fileName, 'editor','text/html');
                zipFile();
            });

            const saver = document.querySelector(".save-button");


            async function zipFile() {
                var zip = new JSZip();

                const resNotes = await fetch('/notes');
                const dataNotes = await resNotes.json();

                const reshtml = await fetch('/files');
                const datahtml = await reshtml.json();

                var i = 0;

                for (item of dataNotes) {
                    const id = `${item.fileId}`;
                    

                    const element = document.createElement("div");
                    buildDOM(element, datahtml[id]);

                    console.log("fileId");
                    console.log(element); 
                    console.log(element.outerHTML);
                    zip.file("file"+i+".html", element.outerHTML);
                    i+=1;
                }

                zip.file("Hello.txt", "Hello World\n");
                

                zip.generateAsync({type:"blob"}).then(function(content) {
                    // see FileSaver.js
                    saveAs(content, "example.zip");
                });

            }

            

            function buildDOM(element, jsonObject) { // element is the parent element to add the children to
                if (typeof jsonObject == "string") {
                    jsonObject = JSON.parse(jsonObject);
                }
                if (Array.isArray(jsonObject)) {
                    for (var i = 0; i < jsonObject.length; i++) {
                        this.buildDOM(element, jsonObject[i]);
                    }
                }
                else {
                    var e = document.createElement(jsonObject.tag);
                    for (var prop in jsonObject) {
                        if (prop != "tag") {
                            if (prop == "children" && Array.isArray(jsonObject[prop])) {
                                this.buildDOM(e, jsonObject[prop]);
                            }
                            else if (prop == "html") {
                                e.innerHTML = jsonObject[prop];
                            }
                            else {
                                e.setAttribute(prop, jsonObject[prop]);
                            }
                        }
                    }
                    element.appendChild(e);
                }
            }
            


            function getCursorPosition() {
                var range = quill.getSelection();
                if (range) {
                    if (range.length == 0) {
                        console.log('User cursor is at index', range.index);
                        return range.index;
                    } else {
                        var text = quill.getText(range.index, range.length);
                        console.log('User has highlighted: ', text);
                    }
                } else {
                    console.log('User cursor is not in editor');
                }
            }

            function drag(dragevent) {
                var text = dragevent.target.id;
                dragevent.dataTransfer.setData("text", text);
                console.log(dragevent.target.id);
                dragevent.target.style.color = 'green';
            }

            function drop(dropevent) {
                dropevent.preventDefault();
                var note = dropevent.dataTransfer.getData("text");
                console.log(document.getElementById(note));
                const cursor = getCursorPosition();
                // quill.format('highlight', note);
                var highlength = 0;
                if (document.getElementById(note).lastElementChild.innerText.length != 0) {
                    quill.insertText(getCursorPosition(), " [");
                    quill.insertText(getCursorPosition(), document.getElementById(note).lastElementChild.innerText, true);
                    quill.insertText(getCursorPosition(), "] ");
                    highlength = 4;
                }
                quill.insertText(getCursorPosition(), document.getElementById(note).firstElementChild.innerText, true);
                quill.insertText(getCursorPosition(), " "); 
                quill.formatText(cursor + document.getElementById(note).lastElementChild.innerText.length + highlength , document.getElementById(note).firstElementChild.innerText.length ,'highlight', note);
                iterId();
                // dropevent.target.appendChild(document.getElementById(data));
                // document.getElementById("drag").style.color = 'black';
            }

            function highlight(id) {
                id.className = "hightlighted-element";
            }

            function unhighlight(id) {
                id.className = "element";
            }

            function iterId() {
                console.log("iteration");
                console.log(iter);
                iter += 1;
            }

            // function saveAsPdf() {
            //     const doc = quill.root.innerHTML;
            //     var x = window.open();
            //     x.document.open();
            //     x.document.write(doc);

            //     x.print();
            //     x.close();
            // }

            // saver.addEventListener("click", saveAsPdf);



        </script>




    </div>

    <script src="./edit.js"></script>

</body>

</html>